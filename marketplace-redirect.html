<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–∫—Ä—ã—Ç–∏–µ ADK App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stores {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }

        .stores h3 {
            font-size: 14px;
            color: #999;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .store-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .debug {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 12px;
            text-align: left;
            color: #666;
            display: none;
        }

        .debug.show {
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo">üì±</div>
    <h1 id="title">–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...</h1>
    <p id="status">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    <div class="spinner" id="spinner"></div>

    <div id="fallback" style="display: none;">
        <button class="btn" id="openAppBtn">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>

        <div class="stores">
            <h3>–°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
            <div class="store-buttons">
                <a href="https://play.google.com/store/apps/details?id=kz.trk.adk" class="btn" target="_blank">
                    Google Play
                </a>
                <a href="https://apps.apple.com/app/idYOUR_APP_ID" class="btn" target="_blank">
                    App Store
                </a>
            </div>
        </div>
    </div>

    <div id="debug" class="debug">
        <strong>Debug Info:</strong><br>
        <div id="debugContent"></div>
    </div>
</div>

<script>
    // Debug —Ä–µ–∂–∏–º
    const DEBUG = true;

    function debug(msg) {
        if (DEBUG) {
            console.log(msg);
            const debugDiv = document.getElementById('debugContent');
            debugDiv.innerHTML += msg + '<br>';
            document.getElementById('debug').classList.add('show');
        }
    }

    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const path = window.location.pathname;
    const searchParams = new URLSearchParams(window.location.search);

    debug('Path: ' + path);
    debug('Search: ' + window.location.search);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const isAndroid = /android/i.test(userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
    const isMobile = isAndroid || isIOS;

    debug('Android: ' + isAndroid);
    debug('iOS: ' + isIOS);
    debug('Mobile: ' + isMobile);

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const ANDROID_PACKAGE = 'kz.trk.adk';
    const IOS_APP_ID = 'YOUR_APP_ID'; // –ó–∞–º–µ–Ω–∏—Ç–µ!
    const CUSTOM_SCHEME = 'adkapp';

    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ –ø—É—Ç–∏
    let deepLinkPath = '';
    let productId = '';

    if (path.includes('/marketplace-product/')) {
        productId = path.split('/marketplace-product/')[1].split('/')[0].split('?')[0];
        deepLinkPath = `marketplace-product/${productId}`;
        debug('Product ID: ' + productId);
    } else if (path.includes('/marketplace-epay-processing/')) {
        const paymentId = path.split('/marketplace-epay-processing/')[1].split('/')[0].split('?')[0];
        deepLinkPath = `marketplace-epay-processing/${paymentId}`;
        debug('Payment ID: ' + paymentId);
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å—Å—ã–ª–æ–∫
    const customSchemeLink = `${CUSTOM_SCHEME}://${deepLinkPath}`;
    const httpsLink = `https://adk-app.netlify.app/${deepLinkPath}`;

    debug('Custom Scheme: ' + customSchemeLink);
    debug('HTTPS Link: ' + httpsLink);

    let appOpened = false;
    let attemptCount = 0;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è Android
    function tryOpenAndroid() {
        debug('Trying Android method ' + (++attemptCount));

        if (attemptCount === 1) {
            // –ü–æ–ø—ã—Ç–∫–∞ 1: Android Intent (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π)
            const intentUrl = `intent://${deepLinkPath}#Intent;scheme=https;package=${ANDROID_PACKAGE};end`;
            debug('Intent URL: ' + intentUrl);
            window.location.href = intentUrl;

            setTimeout(() => {
                if (!appOpened) tryOpenAndroid();
            }, 800);
        }
        else if (attemptCount === 2) {
            // –ü–æ–ø—ã—Ç–∫–∞ 2: Custom Scheme (fallback)
            debug('Custom Scheme: ' + customSchemeLink);
            window.location.href = customSchemeLink;

            setTimeout(() => {
                if (!appOpened) tryOpenAndroid();
            }, 800);
        }
        else if (attemptCount === 3) {
            // –ü–æ–ø—ã—Ç–∫–∞ 3: HTTPS deep link
            debug('HTTPS: ' + httpsLink);
            window.location.href = httpsLink;

            setTimeout(() => {
                if (!appOpened) showFallback();
            }, 1500);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è iOS
    function tryOpenIOS() {
        debug('Trying iOS Universal Link');

        // iOS: –°—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º Universal Link
        window.location.href = httpsLink;

        setTimeout(() => {
            if (!appOpened) {
                debug('Trying iOS Custom Scheme');
                window.location.href = customSchemeLink;
            }
        }, 1000);

        setTimeout(() => {
            if (!appOpened) showFallback();
        }, 2500);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback —Å—Ç—Ä–∞–Ω–∏—Ü—É
    function showFallback() {
        debug('Showing fallback');
        appOpened = true; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–æ–ø—ã—Ç–∫–∏

        document.getElementById('spinner').style.display = 'none';
        document.getElementById('title').textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
        document.getElementById('status').textContent = '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
        document.getElementById('fallback').style.display = 'block';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
    document.getElementById('openAppBtn').addEventListener('click', () => {
        debug('Manual open clicked');

        if (isAndroid) {
            // –î–ª—è Android —Å–Ω–∞—á–∞–ª–∞ Intent, –ø–æ—Ç–æ–º Custom Scheme
            const intentUrl = `intent://${deepLinkPath}#Intent;scheme=https;package=${ANDROID_PACKAGE};end`;
            window.location.href = intentUrl;

            setTimeout(() => {
                window.location.href = customSchemeLink;
            }, 500);
        } else if (isIOS) {
            window.location.href = customSchemeLink;
        } else {
            alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞ iOS –∏ Android');
        }
    });

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—Ä—ã–ª–æ—Å—å –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            debug('Page hidden - app likely opened');
            appOpened = true;
        }
    });

    window.addEventListener('blur', () => {
        debug('Window blur - app likely opened');
        appOpened = true;
    });

    window.addEventListener('pagehide', () => {
        debug('Page hide - app likely opened');
        appOpened = true;
    });

    // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞
    window.addEventListener('load', () => {
        debug('Page loaded, starting...');

        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        setTimeout(() => {
            if (isAndroid) {
                tryOpenAndroid();
            } else if (isIOS) {
                tryOpenIOS();
            } else {
                // Desktop
                debug('Desktop detected');
                document.getElementById('title').textContent = '–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
                document.getElementById('status').textContent = '–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
                showFallback();
            }
        }, 300);
    });
</script>
</body>
</html>